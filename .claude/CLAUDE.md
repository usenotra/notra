# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Notra is a content engine SaaS application built with Next.js 16 (App Router), React 19, and TypeScript. It helps companies manage content by integrating with GitHub repositories and using AI to generate changelogs and other content outputs.

## Commands

```bash
# Development
bun dev              # Start development server
bun build            # Production build
bun start            # Start production server

# Code Quality
bun lint             # Check for linting issues (uses Ultracite/Biome)
bun format           # Auto-fix formatting and lint issues

# Database (Drizzle + PostgreSQL)
bun db:generate      # Generate migrations from schema changes
bun db:migrate       # Run pending migrations
bun db:push          # Push schema directly (dev only)
bun db:studio        # Open Drizzle Studio GUI

# Auth Schema
bun auth:generate    # Regenerate better-auth schema
```

## Architecture

### Tech Stack
- **Framework**: Next.js 16 with App Router, React Compiler enabled
- **Database**: PostgreSQL with Drizzle ORM (`src/lib/db/`)
- **Auth**: better-auth with organizations plugin (`src/lib/auth/server.ts`)
- **AI**: Vercel AI SDK with OpenRouter provider (`src/lib/openrouter.ts`)
- **Caching**: Upstash Redis for session storage and progress tracking
- **Workflows**: `workflow` package for durable execution (brand analysis)
- **Rich Text**: Lexical editor for content editing

### Route Structure
- `src/app/(auth)/` - Authentication pages (login, signup, logout, callback)
- `src/app/(dashboard)/[slug]/` - Organization-scoped dashboard pages
- `src/app/api/organizations/[organizationId]/` - Organization-scoped API routes

### Key Patterns

**Organization-scoped Resources**: Most features are scoped to organizations. The `[slug]` param identifies the org in the UI, while API routes use `[organizationId]`.

**AI Agents** (`src/lib/ai/agents/`): Use `ToolLoopAgent` from the AI SDK with Supermemory for organizational context:
- `chat.ts` - Content editor assistant with markdown editing tools
- `changelog.ts` - GitHub changelog generator

**Workflows** (`src/lib/workflows/`): Durable functions using `"use workflow"` and `"use step"` directives for multi-step processes like brand analysis.

**Database Schema** (`src/lib/db/schema.ts`): Core tables include `users`, `organizations`, `members`, `githubIntegrations`, `githubRepositories`, `repositoryOutputs`, and `brandSettings`.

### Component Organization
- `src/components/ui/` - shadcn/ui components (auto-generated, do not modify)
- `src/components/ai-elements/` - AI chat interface components
- `src/components/content/` - Content editing components including Lexical editor
- `src/components/dashboard/` - Dashboard layout and navigation
- `src/components/integrations/` - GitHub integration management

### Utilities
- `src/utils/schemas/` - Zod validation schemas
- `src/utils/query-keys.ts` - TanStack Query key factories
- `src/lib/utils.ts` - Shared utilities including `cn()` for class merging

## Code Standards

This project uses **Ultracite** (Biome-based) for formatting and linting. Run `bun format` before committing.

For detailed code quality guidelines, conventions, and best practices, see [`ULTRACITE.md`](./ULTRACITE.md).

## Protected Files

**Never modify `src/components/ui/*`** - these are auto-generated by shadcn/ui. Use `bunx --bun shadcn@latest add <component>` to add new components.

## Environment Variables

Required variables (see `.env.example` if available):
- `DATABASE_URL` - PostgreSQL connection string
- `OPENROUTER_API_KEY` - AI provider API key
- `GITHUB_CLIENT_ID` / `GITHUB_CLIENT_SECRET` - OAuth
- `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` - OAuth
- Upstash Redis credentials
